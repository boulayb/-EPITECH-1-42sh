/*
** get_42shrc.c for shell_get_line in /home/cassin_f/PSU_2014_42sh/sources/termcaps
** 
** Made by François CASSIN
** Login   <cassin_f@epitech.net>
** 
** Started on  Fri May 22 14:20:05 2015 François CASSIN
** Last update Fri May 22 14:40:14 2015 François CASSIN
*/

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdlib.h>
#include "my_get_line.h"

static char	*get_rcfile_name(char *home)
{
  char		*file;

  if ((file = malloc(sizeof(char) * (my_strlen(home) +
				     my_strlen(RC_FILE) + 2))) == NULL)
    return (NULL);
  strcpy(file, home);
  strcat(file, "/");
  strcat(file, RC_FILE);
  return (file);
}

static char	*get_line_rc(int fd, int *ret)
{
  char		*s;

  while ((s = get_next_line(fd)) != NULL)
    {
      *ret = 2;
      return (s);
    }
  close(fd);
  *ret = 0;
  return (NULL);
}

char		*check_42shrc(t_env *env, int *ret)
{
  char		*home;
  char		*file;
  static int	fd;

  if (fd == 0)
    {
      if ((home = get_env("HOME=", env)) == NULL)
	return (NULL);
      home = home + 5;
      if ((file = get_rcfile_name(home)) == NULL)
	return (NULL);
      if ((fd = open(file, O_RDONLY)) == -1)
	{
	  *ret = 0;
	  free(file);
	  return (NULL);
	}
    }
  free(file);
  return (get_line_rc(fd, ret));
}
